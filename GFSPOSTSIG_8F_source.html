<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>UPP: GFSPOSTSIG.F Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">UPP
   &#160;<span id="projectnumber">V11.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Types&#160;List</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('GFSPOSTSIG_8F_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">GFSPOSTSIG.F</div>  </div>
</div><!--header-->
<div class="contents">
<a href="GFSPOSTSIG_8F.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="keyword">subroutine </span>rtsig(lusig,head,k1,k2,kgds,ijo,levs,ntrac,jcap,lnt2,me,     &amp;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;                 h,p,px,py,t,u,v,d,trc,iret)</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  <span class="keywordtype">use </span>sigio_module<span class="keywordtype">,   only</span> : sigio_intkind, sigio_head</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  <span class="keywordtype">use </span>sigio_r_module<span class="keywordtype">, only</span> : sigio_dati, sigio_rrdati</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  <span class="keywordtype">use </span><a class="code" href="classphyscons__post.html">physcons_post</a><span class="keywordtype">,       only</span> : con_omega, con_fvirt</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  <span class="keywordtype">use </span>omp_lib</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;  <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  <span class="keywordtype">integer(sigio_intkind)</span>,<span class="keywordtype">intent(in)</span>    :: lusig</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  <span class="keywordtype">type(</span>sigio_head<span class="keywordtype">)</span>,      <span class="keywordtype">intent(in)</span>    :: head</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  <span class="keywordtype">integer</span>,<span class="keywordtype">intent(in)</span>                   :: k1,k2,kgds(200),ijo,levs,ntrac,jcap,lnt2,me</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  <span class="keywordtype">real</span>,<span class="keywordtype">dimension(ijo)</span>,   <span class="keywordtype">intent(out)</span>   :: h,p,px,py</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  <span class="keywordtype">real</span>,<span class="keywordtype">dimension(ijo,k1:k2)</span>,<span class="keywordtype">intent(out)</span>:: t,u,v,d</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;  <span class="keywordtype">real</span>,<span class="keywordtype">dimension(ijo,k1:k2,ntrac)</span>,<span class="keywordtype">intent(out)</span>,<span class="keywordtype">target</span> :: trc</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;  <span class="keywordtype">integer</span>,<span class="keywordtype">intent(out)</span> :: iret</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;  <span class="keywordtype">integer</span> idrt,io,jo,iidea</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment">! integer idrt,io,jo,mo3,mct,iidea,midea</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  <span class="keywordtype">integer(sigio_intkind)</span>:: irets</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment">! type(sigio_datm):: datm</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  <span class="keywordtype">type(</span>sigio_dati<span class="keywordtype">)</span> dati</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="comment">! type griddata</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="comment">! real,dimension(:,:),pointer :: datm</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment">! endtype griddata</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="comment">! type(griddata),dimension(:),pointer :: datatrc</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">target</span> ::  trisca(lnt2,k1:k2+1), triscb(lnt2,k1:k2)</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  <span class="keywordtype">real</span>,<span class="keywordtype">dimension(:)</span>,  <span class="keywordtype">allocatable</span> :: cpi</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  <span class="keywordtype">real</span>,<span class="keywordtype">dimension(:,:)</span>,<span class="keywordtype">allocatable</span> :: wrk</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  <span class="keywordtype">integer</span> io3,ict,jct,n,i,k,jc,nt</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  <span class="keywordtype">integer</span> idvm, klen</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  <span class="keywordtype">real</span>    pmean,sumq,xcp</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment">! integer, parameter :: latch=20</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="comment">! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment">!  Determine output grid</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  idrt = kgds(1)</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="keywordflow">if</span>(kgds(1) == 0 .and. kgds(4) &lt; 90000) idrt = 256</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  io = kgds(2)</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  jo = kgds(3)</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="comment">! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment">!  Read and transform surface fields</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  iret = 1</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <span class="keywordflow">if</span> (me == 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    print*,<span class="stringliteral">&#39;Debug rtsig= &#39;</span>,lusig,k1,k2,ijo,kgds(1:20)</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  <span class="keywordflow">endif</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  idvm  = head%idvm</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment">! jc = omp_get_num_threads()</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment">! write(0,*)&#39; in RTSIG lnt2=&#39;,lnt2,&#39; threads=&#39;,jc,&#39; latch=&#39;,latch,   &amp;</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment">!          &#39; jcap=&#39;,jcap,&#39; io=&#39;,io,&#39; jo=&#39;,jo,&#39; ijo=&#39;,ijo</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  <span class="keywordflow">if</span> (k2 &lt; k1) <span class="keywordflow">return</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  dati%i = 1                                           <span class="comment">! hs</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  dati%f =&gt; trisca(:,k1)</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  call sigio_rrdati(lusig,head,dati,irets)</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  <span class="keywordflow">if</span>(irets /= 0) <span class="keywordflow">return</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment">! call sptez(0,jcap,idrt,io,jo,trisca(1,k1),h,1)</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment">! call sptez(0,jcap,idrt,io,jo,dats%hs,h,1)</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment">! call sptez(0,jcap,idrt,io,jo,dats%ps,p,1)</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment">! call sptezj(jcap,lnt2,1,idrt,io,jo,jc,trisca,h,latch,1)</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  dati%i = 2                               <span class="comment">! Surface pressure</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  dati%f =&gt; trisca(:,k1+1)</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  call sigio_rrdati(lusig,head,dati,irets)</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  <span class="keywordflow">if</span>(irets /= 0) <span class="keywordflow">return</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment">! call sptez(0,jcap,idrt,io,jo,trisca(1,k1),p,1)</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment">! call sptezj(jcap,lnt2,1,idrt,io,jo,jc,trisca,p,latch,1)</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment">!--</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;  <span class="keyword">allocate</span>(wrk(ijo,2))</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  call sptezm(0,jcap,idrt,io,jo,2,trisca(1,k1),wrk,1)</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  <span class="keywordflow">if</span>( mod(idvm,10) &lt; 2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment">!$omp parallel do private(i)</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keywordflow">do</span> i=1,ijo</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;      h(i) = wrk(i,1)</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;      p(i) = 1.e3*exp(wrk(i,2))</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">!     p(i) = 1.e3*exp(p(i))</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  <span class="keywordflow">elseif</span>(mod(idvm,10) == 2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment">!$omp parallel do private(i)</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <span class="keywordflow">do</span> i=1,ijo</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;      h(i) = wrk(i,1)</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;      p(i) = 1000.*wrk(i,2)</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment">!     p(i) = 1000.*p(i)</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  <span class="keywordflow">endif</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(wrk)) <span class="keyword">deallocate</span>(wrk)</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  call sptezd(0,jcap,idrt,io,jo,trisca(1,k1+1),pmean,px,py,1)</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  iret = 0</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment">! if (k2 &lt; k1) return</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment">! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="comment">!  Read and transform fields on levels k1 through k2</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  iret = 2</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;  <span class="keywordflow">if</span> (k2 &gt;= k1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    klen = k2-k1+1</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="keywordflow">do</span> k=k1,k2</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;      <span class="keyword">write</span>(0,*)<span class="stringliteral">&#39; retriving T for k=&#39;</span>,k,<span class="stringliteral">&#39; k1=&#39;</span>,k1,<span class="stringliteral">&#39; k2=&#39;</span>,k2</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;      dati%i = k + 2                        <span class="comment">! Virtual Temperature or CpT</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;      dati%f =&gt; trisca(:,k)</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;      call sigio_rrdati(lusig,head,dati,iret)</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    call sptezm(0,jcap,idrt,io,jo,klen,trisca(1,k1),t(1,k1),1)</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="comment">!   call sptezm(0,jcap,idrt,io,jo,klen,trisca,t,1)</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <span class="keywordflow">do</span> k=k1,k2</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;      dati%i = levs + 2 + (k-1) * 2 + 1     <span class="comment">! Divergence</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;      dati%f =&gt; trisca(:,k)</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;      call sigio_rrdati(lusig,head,dati,irets)</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;      <span class="keywordflow">if</span>(irets /= 0) <span class="keywordflow">return</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;      dati%i = levs + 2 + (k-1) * 2 + 2     <span class="comment">! Vorticity</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;      dati%f =&gt; triscb(:,k)</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;      call sigio_rrdati(lusig,head,dati,irets)</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;      <span class="keywordflow">if</span>(irets /= 0) <span class="keywordflow">return</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    call sptezmv(0,jcap,idrt,io,jo,klen,trisca(1,k1),triscb(1,k1),  &amp;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                 u(1,k1),v(1,k1),1)</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    call sptezm(0,jcap,idrt,io,jo,klen,trisca(1,k1),d(1,k1),1)</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="comment">!   call sptezm(0,jcap,idrt,io,jo,1,triscb,z(1,k),1)</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="keyword">write</span>(0,*)<span class="stringliteral">&#39; retriving d/z for k=&#39;</span>,k,<span class="stringliteral">&#39; k1=&#39;</span>,k1,<span class="stringliteral">&#39; k2=&#39;</span>,k2</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;<span class="comment">!   datm%z(3,:) = datm%z(3,:)+2*con_omega/sqrt(1.5)</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="comment">!   call sptezm(0,jcap,idrt,io,jo,klen,datm%z,z,1)</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;   <span class="keyword">write</span>(0,*)<span class="stringliteral">&#39; start get tracer&#39;</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <span class="keywordflow">do</span> nt=1,ntrac</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;      <span class="keywordflow">do</span> k=k1,k2</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        dati%i = levs * (2+nt) + 2 + k      <span class="comment">! Tracers starting with q</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        dati%f =&gt; trisca(:,k)</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        call sigio_rrdati(lusig,head,dati,irets)</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;      <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;      call sptezm(0,jcap,idrt,io,jo,klen,trisca(1,k1),trc(1,k1,nt),1)</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;      <span class="keyword">write</span>(0,*)<span class="stringliteral">&#39; retriving d/z for nt=&#39;</span>,nt,<span class="stringliteral">&#39;ntrac=&#39;</span>,ntrac,<span class="stringliteral">&#39;k=&#39;</span>,k,<span class="stringliteral">&#39; k1=&#39;</span>,k1,<span class="stringliteral">&#39; k2=&#39;</span>,k2</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="comment">!t=t/(1+con_fvirt*sh)</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;   <span class="keyword">write</span>(0,*)<span class="stringliteral">&#39; end get tracer,idvm=&#39;</span>,idvm,<span class="stringliteral">&#39;ijo=&#39;</span>,ijo,<span class="stringliteral">&#39;ntrac=&#39;</span>,ntrac</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="comment">!-- get temp </span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="keywordflow">if</span> (mod(idvm/10,10) == 3) <span class="keywordflow">then</span> <span class="comment">! Enthalpy case</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;      <span class="keyword">allocate</span>(cpi(0:ntrac))</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">!     write(0,*)&#39;aft read sig, cpi=&#39;,head%cpi</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;      cpi(0:ntrac) = head%cpi(1:ntrac+1)</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="comment">!     write(0,*)&#39;cpi=&#39;,cpi(0:ntrac)</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="comment">!$omp parallel do private(k,i,xcp,sumq,n)</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;      <span class="keywordflow">do</span> k=k1,k2</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        <span class="keywordflow">do</span> i=1,ijo</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;          xcp  = 0.0</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;          sumq = 0.0</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;          <span class="keywordflow">do</span> n=1,ntrac</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;            <span class="keywordflow">if</span>( cpi(n) /= 0.0 ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;              xcp  = xcp  + cpi(n)*trc(i,k,n)</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;              sumq = sumq + trc(i,k,n)</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;            <span class="keywordflow">endif</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;          <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;          xcp    = (1.-sumq)*cpi(0) + xcp</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;          t(i,k) = t(i,k) / xcp   <span class="comment">! Now g1 contains T</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;      <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cpi)) <span class="keyword">deallocate</span>(cpi)</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment">!$omp parallel do private(i,k)</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;      <span class="keywordflow">do</span> k=k1,k2</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        <span class="keywordflow">do</span> i=1,ijo</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;          t(i,k) = t(i,k) / (1+con_fvirt*trc(i,k,1)) <span class="comment">!get temp from virtual temp</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;      <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="keywordflow">endif</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;  <span class="keywordflow">endif</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="comment">! write(0,*)&#39;end comput t&#39;</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;  iret=0</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="comment">! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="keyword">end subroutine  </span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="comment">! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div class="line"><a name="l00255"></a><span class="lineno"><a class="line" href="GFSPOSTSIG_8F.html#a11b7e0a5ee99d552773cdeaddf45a1d3">  255</a></span>&#160;<span class="keyword">  subroutine </span><a class="code" href="GFSPOSTSIG_8F.html#a11b7e0a5ee99d552773cdeaddf45a1d3">modstuff</a>(km,idvc,idsl,nvcoord,vcoord,ps,psx,psy,d,u,v,&amp;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                      pi,pm,om)</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="keywordtype">use </span>sigio_module<span class="keywordtype">, only</span>: sigio_modprd</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="keywordtype">integer</span>,<span class="keywordtype">intent(in)</span>:: km,idvc,idsl,nvcoord</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    <span class="keywordtype">real</span>,<span class="keywordtype">intent(in)</span>:: vcoord(km+1,nvcoord)</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    <span class="keywordtype">real</span>,<span class="keywordtype">intent(in)</span>:: ps,psx,psy</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="keywordtype">real</span>,<span class="keywordtype">intent(in)</span>:: u(km),v(km),d(km)</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment">!   real,intent(out):: pi(km+1),pm(km)</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordtype">real*8</span>, <span class="keywordtype">intent(out)</span>:: pi(km+1),pm(km)</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <span class="keywordtype">real</span>,<span class="keywordtype">intent(out)</span>:: om(km)</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="keywordtype">real*8</span> ps8,pm8(km),pd8(km),vcoord8(km+1,nvcoord)</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <span class="keywordtype">real*8</span> dpmdps(km),dpddps(km),dpidps(km+1),pi8(km+1)</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <span class="keywordtype">real</span> vgradp,pd(km),px(km),py(km),os</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    <span class="keywordtype">integer</span> k,iret,logk</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    ps8=ps</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    vcoord8=vcoord</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    call sigio_modprd(1,1,km,nvcoord,idvc,idsl,vcoord8,iret,&amp;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                     ps=(/ps8/),&amp;</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                     pm=pm8,pd=pd8,dpmdps=dpmdps,dpddps=dpddps)</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="comment">!jw: has to be 8 real for wam     </span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    pi8(1)=ps</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    pm=pm8</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="comment">!   pd=pd8</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    dpidps(1)=1.</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    <span class="keywordflow">do</span> k=1,km</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;      pi8(k+1)=pi8(k)-pd8(k)</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;      dpidps(k+1)=dpidps(k)-dpddps(k)</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">!     if(pi(8)&lt;0.) then</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment">!        print *,&#39;in modstuff,pi8=&#39;,pi8(k)</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">!     endif</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    pi=pi8</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    os=0</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <span class="keywordflow">do</span> k=km,1,-1</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;      vgradp=u(k)*psx+v(k)*psy</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;      os=os-vgradp*ps*(dpmdps(k)-dpidps(k+1))-d(k)*(pm(k)-pi(k+1))</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;      om(k)=vgradp*ps*dpmdps(k)+os</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;      os=os-vgradp*ps*(dpidps(k)-dpmdps(k))-d(k)*(pi(k)-pm(k))</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    px=ps*dpmdps*psx</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    py=ps*dpmdps*psy</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="keyword">  end subroutine</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment">!-------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00333"></a><span class="lineno"><a class="line" href="GFSPOSTSIG_8F.html#a9cdb41b6dbd7dd623e46d2541bd76c77">  333</a></span>&#160;<span class="keyword">  subroutine </span><a class="code" href="GFSPOSTSIG_8F.html#a9cdb41b6dbd7dd623e46d2541bd76c77">modstuff2</a>(im,ix,km,idvc,idsl,nvcoord,vcoord,ps,psx,psy,d,u,v,&amp;</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                       pi,pm,om,me)</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="keywordtype">use </span>sigio_module<span class="keywordtype">, only</span> : sigio_modprd</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="keywordtype">integer</span>,                    <span class="keywordtype">intent(in)</span>  :: im,ix,km,idvc,idsl,nvcoord,me</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <span class="keywordtype">real</span>,                       <span class="keywordtype">intent(in)</span>  :: vcoord(km+1,nvcoord)</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <span class="keywordtype">real</span>,   <span class="keywordtype">dimension(ix)</span>,      <span class="keywordtype">intent(in)</span>  :: ps,psx,psy</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    <span class="keywordtype">real</span>,   <span class="keywordtype">dimension(ix,km)</span>,   <span class="keywordtype">intent(in)</span>  :: u,v,d</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <span class="keywordtype">real*8</span>, <span class="keywordtype">dimension(ix,km+1)</span>, <span class="keywordtype">intent(out)</span> :: pi</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <span class="keywordtype">real*8</span>, <span class="keywordtype">dimension(ix,km)</span>,   <span class="keywordtype">intent(out)</span> :: pm</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="keywordtype">real</span>,   <span class="keywordtype">dimension(ix,km)</span>,   <span class="keywordtype">intent(out)</span> :: om</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="comment">!   real*8, allocatable :: ps8(:), pm8(:,:), pd8(:,:),dpmdps(:,:),dpddps(:,:), &amp;</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="comment">!                          dpidps(:,:),pi8(:,:),vcoord8(:,:)</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;<span class="comment">!   real,   allocatable :: os(:)</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="comment">!   real,   allocatable :: pd(:,:),px(:,:), py(:,:), os(:)</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="comment">!   real vgradpps</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    <span class="keywordtype">real*8</span> ps8(ix),pm8(ix,km),pd8(ix,km),vcoord8(km+1,nvcoord)</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="keywordtype">real*8</span> dpmdps(ix,km),dpddps(ix,km),dpidps(ix,km+1),pi8(ix,km+1)</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="keywordtype">real</span> vgradpps,pd(im,km),os(im)</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="comment">!   real vgradpps,pd(im,km),px(im,km),py(im,km),os(im),tem</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keywordtype">integer</span> i,k,iret,logk</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="comment">! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    ps8     = ps</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    vcoord8 = vcoord</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    call sigio_modprd(im,ix,km,nvcoord,idvc,idsl,vcoord8,iret,                 &amp;</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                     ps=ps8,pd=pd8,dpddps=dpddps,pm=pm8,dpmdps=dpmdps)</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment">!   if (me == 0) then</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="comment">!     write(0,*)&#39; pd8=&#39;,pd8(1,60:64)</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="comment">!     write(0,*)&#39; pm8=&#39;,pm8(1,60:64)</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="comment">!    endif</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;<span class="comment">!jw: has to be 8 real for wam     </span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;<span class="comment">!$omp parallel do private(i)</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="keywordflow">do</span> i=1,im</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;      pi8(i,1)    = ps(i)</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;      dpidps(i,1) = 1.</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;      os(i)       = 0</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;      pi(i,1)     = pi8(i,1)</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="keywordflow">do</span> k=1,km</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="comment">!$omp parallel do private(i)</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;      <span class="keywordflow">do</span> i=1,im</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        pi8(i,k+1)    = pi8(i,k)    - pd8(i,k)</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        dpidps(i,k+1) = dpidps(i,k) - dpddps(i,k)</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="comment">!       if(pi(i,8)&lt;0.) then</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="comment">!          print *,&#39;in modstuff,pi8=&#39;,pi8(i,k),&#39; i=&#39;,i,&#39; k=&#39;,k,&#39; me=&#39;,me</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="comment">!       endif</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;        pi(i,k+1) = pi8(i,k+1)</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        pm(i,k)   = pm8(i,k)</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;      <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <span class="keywordflow">do</span> k=km,1,-1</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="comment">!$omp parallel do private(i,vgradpps)</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;      <span class="keywordflow">do</span> i=1,im</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        vgradpps = (u(i,k)*psx(i) + v(i,k)*psy(i)) * ps(i)</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        os(i)    = os(i) - vgradpps*(dpmdps(i,k)-dpidps(i,k+1))             &amp;</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                         - d(i,k)*(pm(i,k)-pi(i,k+1))</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        om(i,k)  = os(i) + vgradpps*dpmdps(i,k)</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        os(i)    = os(i) - vgradpps*(dpidps(i,k)-dpmdps(i,k))               &amp;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                         - d(i,k)*(pi(i,k)-pm(i,k))</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;      <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="keyword">  end subroutine</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a name="l00444"></a><span class="lineno"><a class="line" href="GFSPOSTSIG_8F.html#a8cde998eca3b5ab50e59f75013461881">  444</a></span>&#160;<span class="keyword">      subroutine </span><a class="code" href="GFSPOSTSIG_8F.html#a8cde998eca3b5ab50e59f75013461881">trssc</a>(jcap,nc,km,ntrac,idvc,idvm,idsl,nvcoord,vcoord,     &amp;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                       cpi,idrt,lonb,latb,ijl,ijn,j1,j2,jc,chgq0,          &amp;</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                       szs,sps,st,sd,sz,sq,gfszs,gfsps,gfsp,gfsdp,         &amp;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                       gfst,gfsu,gfsv,gfsq,gfsw)</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;      <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;      <span class="keywordtype">integer</span>,<span class="keywordtype">intent(in)</span>::jcap,nc,km,ntrac,idvc,idvm,idsl,nvcoord,idrt,lonb,latb</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;      <span class="keywordtype">integer</span>,<span class="keywordtype">intent(in)</span>::ijl,ijn,j1,j2,jc,chgq0</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;      <span class="keywordtype">real</span>,<span class="keywordtype">intent(in)</span>:: szs(nc),sps(nc),st(nc,km),sd(nc,km),sz(nc,km),sq(nc,km*ntrac)</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;      <span class="keywordtype">real</span>,<span class="keywordtype">intent(in)</span>:: cpi(0:ntrac)</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;      <span class="keywordtype">real*8</span>,<span class="keywordtype">intent(in)</span>:: vcoord(km+1,nvcoord)</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;      <span class="keywordtype">real</span>,<span class="keywordtype">dimension(ijn)</span>,<span class="keywordtype">intent(inout)</span>:: gfszs,gfsps</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;      <span class="keywordtype">real</span>,<span class="keywordtype">dimension(ijn,km)</span>,<span class="keywordtype">intent(inout)</span>:: gfsp,gfsdp,gfst,gfsu,gfsv,gfsw</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;      <span class="keywordtype">real</span>,<span class="keywordtype">dimension(ijn,km*ntrac)</span>,<span class="keywordtype">intent(inout)</span>:: gfsq</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;      <span class="keywordtype">real</span> zs(ijl),ps(ijl),t(ijl,km),u(ijl,km),v(ijl,km),q(ijl,km*ntrac)</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;      <span class="keywordtype">real</span> wi(ijl,km),pi(ijl,km),dpo(ijl,km)</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;      <span class="keywordtype">real</span> tvcon,xcp,sumq</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;      <span class="keywordtype">integer</span> thermodyn_id,jn,js,is,in</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;      <span class="keywordtype">integer</span> jj,jjm,k,n,j,i,ij,lonb2</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="comment">! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="comment">!  spectral transforms</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;      <span class="keywordflow">if</span>(j1==732)print*,<span class="stringliteral">&#39;sample input to trssc= &#39;</span>,jcap,nc,km,ntrac, &amp;</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                          idvc,idvm,idsl,nvcoord,    &amp;</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                       idrt,lonb,latb,ijl,ijn,j1,j2,jc,chgq0</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;      lonb2=lonb*2</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;      ij=lonb2*(j2-j1+1)</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;      in=1</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;      is=1+lonb</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;      call sptran(0,jcap,idrt,lonb,latb,1,1,1,lonb2,lonb2,nc,ijl,           &amp;</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                  j1,j2,jc,szs,zs(in),zs(is),1)</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;      call sptran(0,jcap,idrt,lonb,latb,1,1,1,lonb2,lonb2,nc,ijl,           &amp;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                  j1,j2,jc,sps,ps(in),ps(is),1)</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;      call sptran(0,jcap,idrt,lonb,latb,km,1,1,lonb2,lonb2,nc,ijl,          &amp;</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                  j1,j2,jc,st,t(in,1),t(is,1),1)</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;      call sptranv(0,jcap,idrt,lonb,latb,km,1,1,lonb2,lonb2,nc,ijl,         &amp;</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                   j1,j2,jc,sd,sz,u(in,1),u(is,1),v(in,1),v(is,1),1)</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;      call sptran(0,jcap,idrt,lonb,latb,km*ntrac,1,1,lonb2,lonb2,nc,ijl,    &amp;</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                  j1,j2,jc,sq,q(in,1),q(is,1),1)</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;      <span class="keywordflow">if</span>(j1==732)<span class="keywordflow">then</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;       <span class="keywordflow">do</span> k=1,km</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;        <span class="keywordflow">do</span> i=1,ijl</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;     <span class="keywordflow">if</span>(t(i,k)&gt;400. .or. t(i,k)&lt;100.)print*,<span class="stringliteral">&#39;bad T from sptran&#39;</span>,i,k,t(i,k)</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;     <span class="keywordflow">if</span>(q(i,k)&gt;1.)print*,<span class="stringliteral">&#39;bad Q  from sptran&#39;</span>,i,k,q(i,k)</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;     <span class="keywordflow">if</span>(q(i,2*k)&gt;1.)print*,<span class="stringliteral">&#39;bad Q  from sptran&#39;</span>,i,k,q(i,2*k)</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;     <span class="keywordflow">if</span>(q(i,3*k)&gt;1.)print*,<span class="stringliteral">&#39;bad Q  from sptran&#39;</span>,i,k,q(i,3*k)</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;       <span class="keywordflow">end do</span>    </div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;      <span class="keywordflow">end if</span>  </div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;      <span class="keywordflow">select</span> <span class="keywordflow">case</span>(mod(idvm,10))</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;      <span class="keywordflow">case</span>(0,1)</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        <span class="keywordflow">do</span> i=1,ij</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;          ps(i)=1.e3*exp(ps(i))</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;      <span class="keywordflow">case</span>(2)</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;        <span class="keywordflow">do</span> i=1,ij</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;          ps(i)=1.e3*ps(i)</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;        <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;      <span class="keywordflow">case</span> default</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;        <span class="keywordflow">do</span> i=1,ij</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;          ps(i)=1.e3*exp(ps(i))</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;      <span class="keywordflow">end select</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="comment">! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;      thermodyn_id=mod(idvm/10,10)</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;      <span class="keywordflow">if</span> (thermodyn_id == 3) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <span class="keywordflow">do</span> k=1,km</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;         <span class="keywordflow">do</span> i=1,ij</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;            t(i,k) = t(i,k)/cpi(0)   <span class="comment">! enthalpy (cpt/cpd)</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;         <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;      <span class="keywordflow">endif</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;      call getomega(jcap,nc,km,idvc,idvm,idrt,idsl,                    &amp;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        nvcoord,vcoord,lonb,latb,ijl,j1,j2,1,sd,sps,                   &amp;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;        ps,t,u,v,wi,pi,dpo)</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;      <span class="keywordflow">if</span>(j1==732)<span class="keywordflow">then</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;       <span class="keywordflow">do</span> k=1,km</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;        <span class="keywordflow">do</span> i=1,ijl</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;     <span class="keywordflow">if</span>(t(i,k)&gt;400. .or. t(i,k)&lt;100.)print*,<span class="stringliteral">&#39;bad T after getomega&#39;</span>,i,k,t(i,k)</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;     <span class="keywordflow">if</span>(q(i,k)&gt;1. )print*,<span class="stringliteral">&#39;bad Q  after getomega&#39;</span>,i,k,q(i,k)</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;     <span class="keywordflow">if</span>(q(i,2*k)&gt;1. )print*,<span class="stringliteral">&#39;bad Q  after getomega&#39;</span>,i,2*k,q(i,2*k)</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;       <span class="keywordflow">end do</span>    </div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;      <span class="keywordflow">end if</span>  </div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;      <span class="keywordflow">if</span>(thermodyn_id /= 2)<span class="keywordflow">then</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="comment">!  convert to surface pressure and temperature</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;         <span class="keywordflow">if</span> (thermodyn_id == 3) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;           <span class="keywordflow">do</span> k=1,km</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;            <span class="keywordflow">do</span> i=1,ij</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;               xcp  = 0.0</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;               sumq = 0.0</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;               <span class="keywordflow">do</span> n=1,ntrac</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                 <span class="keywordflow">if</span>( cpi(n) /= 0.0 ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                   xcp  = xcp  + cpi(n)*q(i,k+(n-1)*km)</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;                   sumq = sumq + q(i,k+(n-1)*km)</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;                 <span class="keywordflow">endif</span></div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;               <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;               t(i,k)  = t(i,k)/((1.-sumq)*cpi(0)+xcp)</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;            <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;           <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;          <span class="keywordflow">else</span> </div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;           tvcon=(461.50/287.05-1.)</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;           t(:,:) = t(:,:)/(1.+tvcon*q(:,1:km))</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;          <span class="keywordflow">endif</span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;      <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;      <span class="keywordflow">if</span>(j1==732)<span class="keywordflow">then</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;       <span class="keywordflow">do</span> k=1,km</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        <span class="keywordflow">do</span> i=1,ijl</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;     <span class="keywordflow">if</span>(t(i,k)&gt;400. .or. t(i,k)&lt;100.)print*,<span class="stringliteral">&#39;bad T after Tv to T&#39;</span>,i,k,t(i,k)</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;     <span class="keywordflow">if</span>(q(i,k)&gt;1.)print*,<span class="stringliteral">&#39;bad Q  after Tv to T&#39;</span>,i,k,q(i,k)</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;     <span class="keywordflow">if</span>(q(i,2*k)&gt;1. )print*,<span class="stringliteral">&#39;bad Q  after Tv to T&#39;</span>,i,k,q(i,2*k)</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;       <span class="keywordflow">end do</span>    </div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;      <span class="keywordflow">end if</span>  </div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="comment">! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="comment">!----force tracers to be positive</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;      <span class="keywordflow">if</span> (chgq0 == 1) q = max(q, 0.0)</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="comment">! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;<span class="comment">!  pass data to gfsdatao</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;      <span class="keywordflow">do</span> j=1,j2-j1+1</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        jn=j+j1-1</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        js=latb+1-jn</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        jn=(jn-1)*lonb</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;        js=(js-1)*lonb</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;        jj=j*lonb</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        jjm=(j-1)*lonb</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        <span class="keywordflow">do</span> i=1,lonb</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;          gfszs(i+jn) = zs(i+jjm)</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;          gfsps(i+jn) = ps(i+jjm)</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        <span class="keywordflow">do</span> i=1,lonb</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;          gfszs(i+js) = zs(i+jj)</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;          gfsps(i+js) = ps(i+jj)</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        <span class="keywordflow">do</span> k=1,km</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;         <span class="keywordflow">do</span> i=1,lonb</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;          gfsdp(i+jn,k) = dpo(i+jjm,k)</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;          gfsp(i+jn,k)  = pi(i+jjm,k)</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;          gfst(i+jn,k)  = t(i+jjm,k)</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;          gfsu(i+jn,k)  = u(i+jjm,k)</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;          gfsv(i+jn,k)  = v(i+jjm,k)</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;          gfsw(i+jn,k)  = wi(i+jjm,k)</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;         <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;         <span class="keywordflow">do</span> i=1,lonb</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;          gfsdp(i+js,k) = dpo(i+jj,k)</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;          gfsp(i+js,k)  = pi(i+jj,k)</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;          gfst(i+js,k)  = t(i+jj,k)</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;          gfsu(i+js,k)  = u(i+jj,k)</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;          gfsv(i+js,k)  = v(i+jj,k)</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;          gfsw(i+js,k)  = wi(i+jj,k)</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;         <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        <span class="keywordflow">do</span> k=1,km*ntrac</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;          <span class="keywordflow">do</span> i=1,lonb</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;            gfsq(i+jn,k) = q(i+jjm,k)</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;          <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;          <span class="keywordflow">do</span> i=1,lonb</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;            gfsq(i+js,k) = q(i+jj,k)</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;          <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;      <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;      <span class="keywordflow">return</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;      <span class="keywordflow">end</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;<span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;<span class="keyword">      subroutine </span>getomega(jcap,nc,km,idvc,idvm,idrt,idsl,nvcoord,vcoord,  &amp;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;            lonb,latb,ijn,j1,j2,jc,sd,sps,psi,ti,ui,vi,wi,pm,pd)</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;<span class="comment">!!!!!</span></div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;      <span class="keywordtype">use </span>sigio_module<span class="keywordtype">, only</span> : sigio_modprd</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;      <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;      <span class="keywordtype">integer</span>,<span class="keywordtype">intent(in)</span>:: jcap,nc,km,idvc,idvm,idrt,idsl,nvcoord</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;      <span class="keywordtype">integer</span>,<span class="keywordtype">intent(in)</span>:: lonb,latb,j1,j2,jc,ijn</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;      <span class="keywordtype">real*8</span>,<span class="keywordtype">intent(in)</span>:: vcoord(km+1,nvcoord)</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;      <span class="keywordtype">real</span>,<span class="keywordtype">intent(in)</span>:: sd(nc,km),sps(nc)</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;      <span class="keywordtype">real</span>,<span class="keywordtype">intent(in)</span>:: psi(ijn),ti(ijn,km),ui(ijn,km),vi(ijn,km)</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;      <span class="keywordtype">real</span>,<span class="keywordtype">intent(out)</span>:: wi(ijn,km),pm(ijn,km),pd(ijn,km)</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;      <span class="keywordtype">real</span> :: pi(ijn,km+1)</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;      <span class="keywordtype">real</span> :: os</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;      <span class="keywordtype">real*8</span> psi8(ijn),ti8(ijn,km),pm8(ijn,km),pd8(ijn,km)</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;      <span class="keywordtype">real*8</span> dpmdps(ijn,km),dpddps(ijn,km),dpidps(ijn,km+1),vgradp,psmean</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;      <span class="keywordtype">real</span> di(ijn,km),psx(ijn),psy(ijn)</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;      <span class="keywordtype">integer</span> k,i,ij,lonb2,iret,is,in</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;<span class="comment">!----1. spectral transform</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;      lonb2=lonb*2</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;      ij=lonb2*(j2-j1+1)</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;      in=1</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;      is=1+lonb</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;      call sptrand(0,jcap,idrt,lonb,latb,1,1,1,lonb2,lonb2,nc,ijn,    &amp;</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;           j1,j2,jc,sps,psmean,psx(in),psx(is),psy(in),psy(is),1)</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;      call sptran(0,jcap,idrt,lonb,latb,km,1,1,lonb2,lonb2,nc,ijn,    &amp;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                  j1,j2,jc,sd,di(in,1),di(is,1),1)</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;      psi8=psi  </div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;      ti8=ti  </div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;      call sigio_modprd(ijn,ijn,km,nvcoord,idvc,idsl,vcoord,iret,     &amp;</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                   ps=psi8,t=ti8,pm=pm8,pd=pd8,dpmdps=dpmdps,dpddps=dpddps)</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;      pm=pm8</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;      pd=pd8           </div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;      <span class="keywordflow">select</span> <span class="keywordflow">case</span>(mod(idvm,10))</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;      <span class="keywordflow">case</span>(0,1)</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;          <span class="keywordflow">continue</span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;      <span class="keywordflow">case</span>(2)</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;          <span class="keywordflow">do</span> i=1,ijn</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;           psx(i)=psx(i)/(psi(i)*1.0e-3)</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;           psy(i)=psy(i)/(psi(i)*1.0e-3)</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;          <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;      <span class="keywordflow">case</span> default</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;          <span class="keywordflow">do</span> i=1,ijn</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;           psx(i)=psx(i)/psi(i)</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;           psy(i)=psy(i)/psi(i)</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;          <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;      <span class="keywordflow">end select</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="comment">!----3.omeda from modstuff</span></div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;      <span class="keywordflow">do</span> i=1,ijn</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;       pi(i,1)=psi(i)</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;       dpidps(i,1)=1.</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;      <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;      <span class="keywordflow">do</span> k=1,km</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;       <span class="keywordflow">do</span> i=1,ijn</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;         pi(i,k+1)=pi(i,k)-pd(i,k)</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;         dpidps(i,k+1)=dpidps(i,k)-dpddps(i,k)</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;       <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;      <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;      <span class="keywordflow">do</span> i=1,ijn</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;       os=0.</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;       <span class="keywordflow">do</span> k=km,1,-1</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        vgradp=ui(i,k)*psx(i)+vi(i,k)*psy(i)</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        os=os-vgradp*psi(i)*(dpmdps(i,k)-dpidps(i,k+1))-                 &amp;</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;           di(i,k)*(pm(i,k)-pi(i,k+1))</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;        wi(i,k)=vgradp*psi(i)*dpmdps(i,k)+os</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;        os=os-vgradp*psi(i)*(dpidps(i,k)-dpmdps(i,k))-                   &amp;</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;           di(i,k)*(pi(i,k)-pm(i,k))</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;       <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;<span class="comment">!</span></div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;      <span class="keywordflow">enddo</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;<span class="comment">!---</span></div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;       <span class="keywordflow">return</span></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;<span class="keyword">       end subroutine </span></div>
<div class="ttc" id="classphyscons__post_html"><div class="ttname"><a href="classphyscons__post.html">physcons_post</a></div><div class="ttdef"><b>Definition:</b> <a href="physcons_8f_source.html#l00001">physcons.f:1</a></div></div>
<div class="ttc" id="GFSPOSTSIG_8F_html_a9cdb41b6dbd7dd623e46d2541bd76c77"><div class="ttname"><a href="GFSPOSTSIG_8F.html#a9cdb41b6dbd7dd623e46d2541bd76c77">modstuff2</a></div><div class="ttdeci">subroutine modstuff2(im, ix, km, idvc, idsl, nvcoord, vcoord, ps, psx, psy, d, u, v, pi, pm, om, me)</div><div class="ttdoc">modstuff2() computes model coordinate dependent functions. </div><div class="ttdef"><b>Definition:</b> <a href="GFSPOSTSIG_8F_source.html#l00333">GFSPOSTSIG.F:333</a></div></div>
<div class="ttc" id="GFSPOSTSIG_8F_html_a11b7e0a5ee99d552773cdeaddf45a1d3"><div class="ttname"><a href="GFSPOSTSIG_8F.html#a11b7e0a5ee99d552773cdeaddf45a1d3">modstuff</a></div><div class="ttdeci">subroutine modstuff(km, idvc, idsl, nvcoord, vcoord, ps, psx, psy, d, u, v, pi, pm, om)</div><div class="ttdoc">modstuff() computes model coordinate dependent functions. </div><div class="ttdef"><b>Definition:</b> <a href="GFSPOSTSIG_8F_source.html#l00255">GFSPOSTSIG.F:255</a></div></div>
<div class="ttc" id="GFSPOSTSIG_8F_html_a8cde998eca3b5ab50e59f75013461881"><div class="ttname"><a href="GFSPOSTSIG_8F.html#a8cde998eca3b5ab50e59f75013461881">trssc</a></div><div class="ttdeci">subroutine trssc(jcap, nc, km, ntrac, idvc, idvm, idsl, nvcoord, vcoord, cpi, idrt, lonb, latb, ijl, ijn, j1, j2, jc, chgq0, szs, sps, st, sd, sz, sq, gfszs, gfsps, gfsp, gfsdp, gfst, gfsu, gfsv, gfsq, gfsw)</div><div class="ttdoc">trssc() transforms sigma spectral fields to grid. </div><div class="ttdef"><b>Definition:</b> <a href="GFSPOSTSIG_8F_source.html#l00444">GFSPOSTSIG.F:444</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_d8b772108138bf796aaa3f7fe4e09294.html">sorc</a></li><li class="navelem"><a class="el" href="dir_29f0049402def9fd0d109199f2d306c2.html">ncep_post.fd</a></li><li class="navelem"><a class="el" href="GFSPOSTSIG_8F.html">GFSPOSTSIG.F</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
