pipeline {
  agent none
  stages {
    stage('Run ORTs') {
       agent {
        label 'built-in'   
       }
      steps {
        script {
          for (label in pullRequest.labels) {
            if ((label.matches("orion"))) {
                 env.CHOICE_NODE='orion'
            }  
            else if ((label.matches("hera"))) { 
                env.CHOICE_NODE='hera'
            }  
            else if ((label.matches("hercules"))) { 
                env.CHOICE_NODE='hercules'
            }  
            else if ((label.matches("jet"))) {
                env.CHOICE_NODE='jet'
            } 
            else { 
                env.CHOICE_NODE='none'
            }
         }
// Why do I need another if..block?

            if (CHOICE_NODE == 'orion') {
                echo "Starting up orion ${CHOICE_NODE}...this might take 5-10 minutes...please be patient."
               
            } 
             else if (CHOICE_NODE == 'jet') {
                echo "Starting up jet ${CHOICE_NODE}...this might take 5-10 minutes...please be patient."
            }
             else if (CHOICE_NODE == 'hercules') {
                 echo "Starting up hera ${CHOICE_NODE}...this might take 5-10 minutes...please be patient."
            }
             else if (CHOICE_NODE == 'hera') {
                 echo "Starting up hera ${CHOICE_NODE}...this might take 5-10 minutes...please be patient."
            }
             else {
                echo "${CHOICE_NODE} is NOT a platform, moving on..."
            }
       }    
    }
  } 
  stage('Run ORT on Orion') {
        agent {
          label "orion"
        }
        environment {
        ACCNR = 'epic'
        NODE_PATH = '/work/noaa/epic/role-epic/jenkins/workspace'
      }
      steps {
          cleanWs()
					checkout scm
					sh '''
					echo $(pwd)
					cd ci/
          export machine=${NODE_NAME}
          export PATH=$PATH:~/bin
          echo $CHANGE_ID
          export SSH_ORIGIN=$(curl --silent https://api.github.com/repos/NOAA-EMC/UPP/pulls/$CHANGE_ID | jq -r '.head.repo.ssh_url')
          export FORK_BRANCH=$(curl --silent https://api.github.com/repos/NOAA-EMC/UPP/pulls/$CHANGE_ID | jq -r '.head.ref')
					./rt.sh -a ${ACCNR} -r `pwd`/rundir -t `pwd`/../
          cd ../tests/logs
          git remote -v
          git fetch --no-recurse-submodules origin
          git config user.email "ecc.platform@noaa.gov"
          git config user.name "epic-cicd-jenkins"
          echo "Orion testing concluded..."
          export machine_name_logs=$(echo $machine | awk '{ print tolower($1) }')
          git remote -v | grep -w sshorigin > /dev/null 2>&1 && git remote remove sshorigin > /dev/null 2>&1
          git remote add sshorigin $SSH_ORIGIN > /dev/null 2>&1
					git add rt.log.ORION
          git commit -m "Orion Jobs Completed."
          git pull $FORK_BRANCH
          git push HEAD:$FORK_BRANCH
        '''
        }
      }	      
  }
}
