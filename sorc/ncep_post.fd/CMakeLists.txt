cmake_minimum_required(VERSION 2.6)

set(EXENAME ncep_post )
set(LIBNAME nceppost )
set(LIB_SRC
${CMAKE_CURRENT_SOURCE_DIR}/AllGETHERV_GSD.f
${CMAKE_CURRENT_SOURCE_DIR}/ALLOCATE_ALL.f
${CMAKE_CURRENT_SOURCE_DIR}/ASSIGNNEMSIOVAR.f
${CMAKE_CURRENT_SOURCE_DIR}/AVIATION.f
${CMAKE_CURRENT_SOURCE_DIR}/blockIO.c
${CMAKE_CURRENT_SOURCE_DIR}/BNDLYR.f
${CMAKE_CURRENT_SOURCE_DIR}/BOUND.f
${CMAKE_CURRENT_SOURCE_DIR}/CALCAPE.f
${CMAKE_CURRENT_SOURCE_DIR}/CALDRG.f
${CMAKE_CURRENT_SOURCE_DIR}/CALDWP.f
${CMAKE_CURRENT_SOURCE_DIR}/CALGUST.f
${CMAKE_CURRENT_SOURCE_DIR}/CALHEL.f
${CMAKE_CURRENT_SOURCE_DIR}/CALLCL.f
${CMAKE_CURRENT_SOURCE_DIR}/CALMCVG.f
${CMAKE_CURRENT_SOURCE_DIR}/CALMICT.f
${CMAKE_CURRENT_SOURCE_DIR}/CALPBL.f
${CMAKE_CURRENT_SOURCE_DIR}/CALPBLREGIME.f
${CMAKE_CURRENT_SOURCE_DIR}/CALPOT.f
${CMAKE_CURRENT_SOURCE_DIR}/CALPW.f
${CMAKE_CURRENT_SOURCE_DIR}/CALRAD_WCLOUD_newcrtm.f
${CMAKE_CURRENT_SOURCE_DIR}/CALRCH.f
${CMAKE_CURRENT_SOURCE_DIR}/CALRH.f
${CMAKE_CURRENT_SOURCE_DIR}/CALRH_GFS.f
${CMAKE_CURRENT_SOURCE_DIR}/CALRH_GSD.f
${CMAKE_CURRENT_SOURCE_DIR}/CALRH_PW.f
${CMAKE_CURRENT_SOURCE_DIR}/CALSTRM.f
${CMAKE_CURRENT_SOURCE_DIR}/CALTAU.f
${CMAKE_CURRENT_SOURCE_DIR}/CALTHTE.f
${CMAKE_CURRENT_SOURCE_DIR}/CALUPDHEL.f
${CMAKE_CURRENT_SOURCE_DIR}/CALVIS.f
${CMAKE_CURRENT_SOURCE_DIR}/CALVIS_GSD.f
${CMAKE_CURRENT_SOURCE_DIR}/CALVOR.f
${CMAKE_CURRENT_SOURCE_DIR}/CALWXT_BOURG.f
${CMAKE_CURRENT_SOURCE_DIR}/CALWXT_DOMINANT.f
${CMAKE_CURRENT_SOURCE_DIR}/CALWXT_EXPLICIT.f
${CMAKE_CURRENT_SOURCE_DIR}/CALWXT.f
${CMAKE_CURRENT_SOURCE_DIR}/CALWXT_RAMER.f
${CMAKE_CURRENT_SOURCE_DIR}/CALWXT_REVISED.f
${CMAKE_CURRENT_SOURCE_DIR}/CANRES.f
${CMAKE_CURRENT_SOURCE_DIR}/CLDFRAC_ZHAO.f
${CMAKE_CURRENT_SOURCE_DIR}/CLDRAD.f
${CMAKE_CURRENT_SOURCE_DIR}/CLMAX.f
${CMAKE_CURRENT_SOURCE_DIR}/CMASSI.f
${CMAKE_CURRENT_SOURCE_DIR}/COLLECT.f
${CMAKE_CURRENT_SOURCE_DIR}/COLLECT_LOC.f
${CMAKE_CURRENT_SOURCE_DIR}/CTLBLK.f
${CMAKE_CURRENT_SOURCE_DIR}/cuparm.f
${CMAKE_CURRENT_SOURCE_DIR}/DEALLOCATE.f
${CMAKE_CURRENT_SOURCE_DIR}/DEWPOINT.f
${CMAKE_CURRENT_SOURCE_DIR}/ETCALC.f
${CMAKE_CURRENT_SOURCE_DIR}/EXCH2.f
${CMAKE_CURRENT_SOURCE_DIR}/EXCH.f
${CMAKE_CURRENT_SOURCE_DIR}/FDLVL.f
${CMAKE_CURRENT_SOURCE_DIR}/FGAMMA.f
${CMAKE_CURRENT_SOURCE_DIR}/FILL_PSETFLD.f
${CMAKE_CURRENT_SOURCE_DIR}/FIXED.f
${CMAKE_CURRENT_SOURCE_DIR}/FRZLVL2.f
${CMAKE_CURRENT_SOURCE_DIR}/FRZLVL.f
${CMAKE_CURRENT_SOURCE_DIR}/GEO_ZENITH_ANGLE.f
${CMAKE_CURRENT_SOURCE_DIR}/GET_BITS.f
${CMAKE_CURRENT_SOURCE_DIR}/GETGBANDSCATTER.f
${CMAKE_CURRENT_SOURCE_DIR}/getIVariableN.f
${CMAKE_CURRENT_SOURCE_DIR}/GETNEMSNDSCATTER.f
${CMAKE_CURRENT_SOURCE_DIR}/get_postfilename.f
${CMAKE_CURRENT_SOURCE_DIR}/getVariable.f
${CMAKE_CURRENT_SOURCE_DIR}/GFIP3.f
${CMAKE_CURRENT_SOURCE_DIR}/GFSPOST.F
${CMAKE_CURRENT_SOURCE_DIR}/GPVS.f
${CMAKE_CURRENT_SOURCE_DIR}/grib2_module.f
${CMAKE_CURRENT_SOURCE_DIR}/GRIBIT.F
${CMAKE_CURRENT_SOURCE_DIR}/GRIDAVG.f
${CMAKE_CURRENT_SOURCE_DIR}/GRIDSPEC.f
${CMAKE_CURRENT_SOURCE_DIR}/gtg_algo.f90
${CMAKE_CURRENT_SOURCE_DIR}/gtg_compute.f90
${CMAKE_CURRENT_SOURCE_DIR}/gtg_config.f90
${CMAKE_CURRENT_SOURCE_DIR}/gtg_ctlblk.f90
${CMAKE_CURRENT_SOURCE_DIR}/gtg_filter.f90
${CMAKE_CURRENT_SOURCE_DIR}/gtg_indices.f90
${CMAKE_CURRENT_SOURCE_DIR}/gtg_smoothseams.f90
${CMAKE_CURRENT_SOURCE_DIR}/ICAOHEIGHT.f
${CMAKE_CURRENT_SOURCE_DIR}/INITPOST.F
${CMAKE_CURRENT_SOURCE_DIR}/INITPOST_GFS.f
${CMAKE_CURRENT_SOURCE_DIR}/INITPOST_GFS_NEMS.f
${CMAKE_CURRENT_SOURCE_DIR}/INITPOST_GFS_NEMS_MPIIO.f
${CMAKE_CURRENT_SOURCE_DIR}/INITPOST_GFS_SIGIO.f
${CMAKE_CURRENT_SOURCE_DIR}/INITPOST_NEMS.f
${CMAKE_CURRENT_SOURCE_DIR}/INITPOST_NEMS_MPIIO.f
${CMAKE_CURRENT_SOURCE_DIR}/INITPOST_NETCDF.f
${CMAKE_CURRENT_SOURCE_DIR}/INITPOST_NMM.f
${CMAKE_CURRENT_SOURCE_DIR}/kinds_mod.F
${CMAKE_CURRENT_SOURCE_DIR}/LFMFLD.f
${CMAKE_CURRENT_SOURCE_DIR}/LFMFLD_GFS.f
${CMAKE_CURRENT_SOURCE_DIR}/LOOKUP.f
${CMAKE_CURRENT_SOURCE_DIR}/machine.f
${CMAKE_CURRENT_SOURCE_DIR}/map_routines.f90
${CMAKE_CURRENT_SOURCE_DIR}/MAPSSLP.f
${CMAKE_CURRENT_SOURCE_DIR}/MASKS_mod.f
${CMAKE_CURRENT_SOURCE_DIR}/MDL2AGL.f
${CMAKE_CURRENT_SOURCE_DIR}/MDL2P.f
${CMAKE_CURRENT_SOURCE_DIR}/MDL2SIGMA2.f
${CMAKE_CURRENT_SOURCE_DIR}/MDL2SIGMA.f
${CMAKE_CURRENT_SOURCE_DIR}/MDL2THANDPV.f
${CMAKE_CURRENT_SOURCE_DIR}/MDLFLD.f
${CMAKE_CURRENT_SOURCE_DIR}/MICROINIT.F
${CMAKE_CURRENT_SOURCE_DIR}/MISCLN.f
${CMAKE_CURRENT_SOURCE_DIR}/MIXLEN.f
${CMAKE_CURRENT_SOURCE_DIR}/MPI_FIRST.f
${CMAKE_CURRENT_SOURCE_DIR}/MPI_LAST.f
${CMAKE_CURRENT_SOURCE_DIR}/MSFPS.f
${CMAKE_CURRENT_SOURCE_DIR}/native_endianness.f
${CMAKE_CURRENT_SOURCE_DIR}/NGMFLD.f
${CMAKE_CURRENT_SOURCE_DIR}/NGMSLP.f
${CMAKE_CURRENT_SOURCE_DIR}/OTLFT.f
${CMAKE_CURRENT_SOURCE_DIR}/OTLIFT.f
${CMAKE_CURRENT_SOURCE_DIR}/PARAMR.f
${CMAKE_CURRENT_SOURCE_DIR}/params.F
${CMAKE_CURRENT_SOURCE_DIR}/PARA_RANGE.f
${CMAKE_CURRENT_SOURCE_DIR}/physcons.f
${CMAKE_CURRENT_SOURCE_DIR}/PMICRPH.f
${CMAKE_CURRENT_SOURCE_DIR}/POLEAVG.f
${CMAKE_CURRENT_SOURCE_DIR}/PROCESS.f
${CMAKE_CURRENT_SOURCE_DIR}/READCNTRL.F
${CMAKE_CURRENT_SOURCE_DIR}/READ_xml.f
${CMAKE_CURRENT_SOURCE_DIR}/retrieve_index.f
${CMAKE_CURRENT_SOURCE_DIR}/RHGRD.f
${CMAKE_CURRENT_SOURCE_DIR}/RQSTFLD.F
${CMAKE_CURRENT_SOURCE_DIR}/SCLFLD.f
${CMAKE_CURRENT_SOURCE_DIR}/SELECT_CHANNELS.f
${CMAKE_CURRENT_SOURCE_DIR}/SERVER.f
${CMAKE_CURRENT_SOURCE_DIR}/SET_LVLSXML.f
${CMAKE_CURRENT_SOURCE_DIR}/SET_OUTFLDS.f
${CMAKE_CURRENT_SOURCE_DIR}/SETUP_SERVERS.f
${CMAKE_CURRENT_SOURCE_DIR}/SLP_new.f
${CMAKE_CURRENT_SOURCE_DIR}/SLP_NMM.f
${CMAKE_CURRENT_SOURCE_DIR}/SMOOTH.f
${CMAKE_CURRENT_SOURCE_DIR}/SNFRAC.f
${CMAKE_CURRENT_SOURCE_DIR}/SNFRAC_GFS.f
${CMAKE_CURRENT_SOURCE_DIR}/SOIL_mod.f
${CMAKE_CURRENT_SOURCE_DIR}/SPLINE.f
${CMAKE_CURRENT_SOURCE_DIR}/SURFCE.f
${CMAKE_CURRENT_SOURCE_DIR}/svptbl.f
${CMAKE_CURRENT_SOURCE_DIR}/TABLE.f
${CMAKE_CURRENT_SOURCE_DIR}/TABLEQ.f
${CMAKE_CURRENT_SOURCE_DIR}/TRPAUS.f
${CMAKE_CURRENT_SOURCE_DIR}/TTBLEX.f
${CMAKE_CURRENT_SOURCE_DIR}/VRBLS2D_mod.f
${CMAKE_CURRENT_SOURCE_DIR}/VRBLS3D_mod.f
${CMAKE_CURRENT_SOURCE_DIR}/VRBLS4D_mod.f
${CMAKE_CURRENT_SOURCE_DIR}/WETBULB.f
${CMAKE_CURRENT_SOURCE_DIR}/WETFRZLVL.f
${CMAKE_CURRENT_SOURCE_DIR}/wrf_io_flags.f
${CMAKE_CURRENT_SOURCE_DIR}/wrf_io_flags.h
${CMAKE_CURRENT_SOURCE_DIR}/xml_perl_data.f
${CMAKE_CURRENT_SOURCE_DIR}/ZENSUN.f)
file(GLOB EXE_SRC *.f *.f90 *.F)
file(GLOB EXE_C_SRC *.c)
list( REMOVE_ITEM EXE_SRC ${LIB_SRC})
list( REMOVE_ITEM EXE_SRC ${CMAKE_CURRENT_SOURCE_DIR}/TRPAUS_NAM.f)
list( REMOVE_ITEM EXE_SRC ${CMAKE_CURRENT_SOURCE_DIR}/WRF_STUBS.f)
if(IntelComp)
    message("setting intel flags")
    set(CMAKE_Fortran_FLAGS " -free -O3 -convert big_endian -traceback -g -fp-model source ${OpenMP_Fortran_FLAGS}" CACHE INTERNAL "" )
    set(CMAKE_C_FLAGS "-DLINUX -Dfunder -DFortranByte=char -DFortranInt=int -DFortranLlong='long long'" CACHE INTERNAL "")
elseif(GNUComp)
    message("setting gnu flags")
    set(CMAKE_Fortran_FLAGS "-ffree-form -ffree-line-length-none -fconvert=big-endian -fbacktrace -g ${OpenMP_Fortran_FLAGS}" CACHE INTERNAL "" )
#    set(CMAKE_Fortran_FLAGS "-O0 -ggdb -fno-unsafe-math-optimizations -frounding-math -fsignaling-nans -ffpe-trap=invalid,zero,overflow -fbounds-check -ffree-form -ffree-line-length-none -fconvert=big-endian -fbacktrace -g ${OpenMP_Fortran_FLAGS}" CACHE INTERNAL "" )
    if(APPLE)
      set(CMAKE_C_FLAGS "-DAPPLE -Dfunder -DFortranByte=char -DFortranInt=int -DFortranLlong='long long'" CACHE INTERNAL "")
    elseif(UNIX)
      set(CMAKE_C_FLAGS "-DLINUX -Dfunder -DFortranByte=char -DFortranInt=int -DFortranLlong='long long'" CACHE INTERNAL "")
    endif(APPLE)
else()
    message("unknown compiler!")
    exit()
endif()

add_executable(${EXENAME} ${EXE_SRC} ${EXE_C_SRC} )
add_library(${LIBNAME} ${LIB_SRC} ${EXE_C_SRC} )
set_source_files_properties( ${EXE_SRC} PROPERTIES COMPILE_FLAGS ${CMAKE_Fortran_FLAGS} )
set_source_files_properties( ${LIB_SRC} PROPERTIES COMPILE_FLAGS ${CMAKE_Fortran_FLAGS} )
set_source_files_properties( ${EXE_C_SRC} PROPERTIES COMPILE_FLAGS ${CMAKE_C_FLAGS} )
set_target_properties( ${EXENAME} PROPERTIES LINK_FLAGS ${OpenMP_Fortran_FLAGS} )
add_dependencies(${EXENAME} ${LIBNAME})

include_directories( ${MPI_Fortran_MODULE_DIR} ${MPI_Fortran_INCLUDE_PATH} ${NETCDF_INCLUDES} ${SIGIO_INC} ${NEMSIO_INC} ${SFCIO_INC} ${W3EMC_INC4} ${G2_INC4} ${G2TMPL_INCd} ${GFSIO_INC} ${CRTM_INC} )
target_link_libraries(${EXENAME} ${LIBNAME} ${SP_LIB4} ${SIGIO_LIB} ${SFCIO_LIB} ${GFSIO_LIB4} ${NEMSIO_LIB} ${IP_LIB4} ${W3EMC_LIB4} ${W3NCO_LIB4} ${G2TMPL_LIBd} ${G2_LIB4} ${CRTM_LIB} ${BACIO_LIB4} ${PNG_LIBRARIES} ${JASPER_LIBRARIES} ${NETCDF_LIBRARIES_F90} ${NETCDF_LIBRARIES} ${HDF5_HL_LIBRARIES} ${HDF5_LIBRARIES} ${ZLIB_LIBRARIES} ${MPI_Fortran_LIBRARIES} ${CMAKE_DL_LIBS} )

install(TARGETS ${EXENAME}
        RUNTIME DESTINATION ${CMAKE_INSTALL_PREFIX}/bin
        LIBRARY DESTINATION ${CMAKE_INSTALL_PREFIX}/lib
        ARCHIVE DESTINATION ${CMAKE_INSTALL_PREFIX}/lib)

install(TARGETS ${LIBNAME}
        RUNTIME DESTINATION ${CMAKE_INSTALL_PREFIX}/bin
        LIBRARY DESTINATION ${CMAKE_INSTALL_PREFIX}/lib
        ARCHIVE DESTINATION ${CMAKE_INSTALL_PREFIX}/lib)

install(DIRECTORY ${CMAKE_INCLUDE_OUTPUT_DIRECTORY}/ DESTINATION include_4 )
